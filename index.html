<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detectify by EngageAI - AI-Powered Chatbot Detection Platform</title>
    <meta name="description" content="Discover and analyze chatbot technologies across local businesses with Detectify by EngageAI. The ultimate tool for data-driven prospecting in conversational AI." />
    <meta name="author" content="EngageAI" />
    <meta property="og:image" content="/og-image.png" />
    <script>
      // Initialize communication channel
      const channel = new BroadcastChannel('detectify-channel');
      
      // Message types
      const MESSAGE_TYPES = {
        UPDATE_ELEMENTS: 'UPDATE_SELECTED_ELEMENTS',
        TOGGLE_SELECTOR: 'TOGGLE_SELECTOR',
        ELEMENTS_UPDATED: 'ELEMENTS_UPDATED',
        SELECTOR_TOGGLED: 'SELECTOR_TOGGLED',
        ERROR: 'ERROR'
      };

      // Allowed origins
      const ALLOWED_ORIGINS = [
        'https://detectifys.engageai.pro',
        'https://detectify.engageai.pro',
        'http://localhost:8080',
        'http://localhost:3000',
        'https://gptengineer.app',
        'https://lovable.dev',
        'https://cdn.gpteng.co'
      ];

      // Handle incoming messages
      window.addEventListener('message', function(event) {
        try {
          // Check if origin is allowed
          if (!ALLOWED_ORIGINS.includes(event.origin)) {
            console.warn('Message received from unauthorized origin:', event.origin);
            return;
          }

          const data = event.data;
          console.log('Received message:', data);
          
          if (!data || !data.type) {
            console.warn('Invalid message format');
            return;
          }

          switch(data.type) {
            case MESSAGE_TYPES.UPDATE_ELEMENTS:
              handleElementUpdate(data);
              break;
            case MESSAGE_TYPES.TOGGLE_SELECTOR:
              handleSelectorToggle(data);
              break;
            default:
              console.log('Unhandled message type:', data.type);
          }
        } catch (error) {
          console.error('Error processing message:', error);
          if (event.source && event.source.postMessage) {
            event.source.postMessage({
              type: MESSAGE_TYPES.ERROR,
              error: error.message
            }, event.origin);
          }
        }
      });

      // Handle element updates
      function handleElementUpdate(data) {
        console.log('Handling element update:', data);
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            type: MESSAGE_TYPES.ELEMENTS_UPDATED,
            success: true
          }, '*');
        }
      }

      // Handle selector toggle
      function handleSelectorToggle(data) {
        console.log('Handling selector toggle:', data);
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({
            type: MESSAGE_TYPES.SELECTOR_TOGGLED,
            success: true
          }, '*');
        }
      }

      // Helper function to send messages
      window.sendMessage = function(message) {
        try {
          console.log('Sending message:', message);
          if (window.parent && window.parent.postMessage) {
            window.parent.postMessage(message, '*');
          }
        } catch (error) {
          console.error('Error sending message:', error);
        }
      };

      console.log('Communication channel initialized');
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>